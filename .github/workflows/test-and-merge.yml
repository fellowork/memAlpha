name: Test and Auto-Merge to Main

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git operations
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.10-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.10-
      
      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest tests/test_models.py tests/test_embeddings.py tests/test_memory_store.py tests/test_scratchpad.py \
            --cov=src --cov-report=term-missing -v

  create-pr:
    name: Create PR to Main
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$PR_NUMBER"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi
      
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head dev \
            --title "ðŸš€ Auto-merge: dev â†’ main" \
            --body "## Automated PR from dev to main

          âœ… All tests passed on dev branch
          
          **Test Results:**
          - Unit tests: Passed
          - Coverage: See report above
          
          **Changes:**
          This PR contains all changes from the \`dev\` branch that have passed tests.
          
          ---
          ðŸ¤– This PR was automatically created and will be auto-merged.")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"
      
      - name: Get PR number
        id: get-pr-number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
            echo "pr_number=${{ steps.check-pr.outputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

  auto-merge:
    name: Auto-Merge PR
    needs: [test, create-pr]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get PR number
        id: get-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"
      
      - name: Merge PR
        if: steps.get-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          # Try auto-merge first (requires branch protection)
          if gh pr merge ${{ steps.get-pr.outputs.pr_number }} --auto --squash --delete-branch 2>/dev/null; then
            echo "âœ… Auto-merge enabled for PR #${{ steps.get-pr.outputs.pr_number }}"
            echo "merge_method=auto" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Auto-merge not available (branch protection not configured)"
            echo "Merging directly instead..."
            
            # Approve first if we have PAT
            if [ -n "${{ secrets.GH_PAT }}" ]; then
              gh pr review ${{ steps.get-pr.outputs.pr_number }} --approve --body "âœ… All tests passed. Auto-approving." || echo "Note: Could not approve (may need different account)"
            fi
            
            # Merge directly
            gh pr merge ${{ steps.get-pr.outputs.pr_number }} --squash --delete-branch
            echo "âœ… PR #${{ steps.get-pr.outputs.pr_number }} merged directly"
            echo "merge_method=direct" >> $GITHUB_OUTPUT
          fi
      
      - name: Summary
        if: steps.get-pr.outputs.pr_number != ''
        run: |
          echo "## âœ… Tests Passed & Merged!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ steps.get-pr.outputs.pr_number }} has been successfully merged to main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View PR](https://github.com/${{ github.repository }}/pull/${{ steps.get-pr.outputs.pr_number }})" >> $GITHUB_STEP_SUMMARY

