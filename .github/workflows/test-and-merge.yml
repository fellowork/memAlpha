name: Test and Auto-Merge to Main

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git operations
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest tests/test_models.py tests/test_embeddings.py tests/test_memory_store.py tests/test_scratchpad.py \
            --cov=src --cov-report=xml --cov-report=term-missing -v
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  create-pr:
    name: Create PR to Main
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if PR exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$PR_NUMBER"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi
      
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head dev \
            --title "ðŸš€ Auto-merge: dev â†’ main" \
            --body "## Automated PR from dev to main

          âœ… All tests passed on dev branch
          
          **Test Results:**
          - Unit tests: Passed
          - Coverage: See report above
          
          **Changes:**
          This PR contains all changes from the \`dev\` branch that have passed tests.
          
          ---
          ðŸ¤– This PR was automatically created and will be auto-merged." \
            --label "automated" \
            --label "auto-merge")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"
      
      - name: Get PR number
        id: get-pr-number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
            echo "pr_number=${{ steps.check-pr.outputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

  auto-merge:
    name: Auto-Merge PR
    needs: [test, create-pr]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get PR number
        id: get-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"
      
      - name: Enable auto-merge
        if: steps.get-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ steps.get-pr.outputs.pr_number }} \
            --auto \
            --squash \
            --delete-branch=false
          echo "âœ… Auto-merge enabled for PR #${{ steps.get-pr.outputs.pr_number }}"
      
      - name: Approve PR
        if: steps.get-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # GitHub doesn't allow self-approval in the same workflow
          # This will be handled by branch protection rules
          echo "PR #${{ steps.get-pr.outputs.pr_number }} ready for auto-merge"
          
          # If you have a bot account or PAT, you can approve here:
          # gh pr review ${{ steps.get-pr.outputs.pr_number }} --approve
      
      - name: Summary
        if: steps.get-pr.outputs.pr_number != ''
        run: |
          echo "## âœ… Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ steps.get-pr.outputs.pr_number }} has been created and is ready to merge." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View PR](https://github.com/${{ github.repository }}/pull/${{ steps.get-pr.outputs.pr_number }})" >> $GITHUB_STEP_SUMMARY

